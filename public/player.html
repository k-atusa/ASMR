<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ASMR Radio Player</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/style.css">
    <script>
        // Extract channel name from query string
        function getChannel() {
            const params = new URLSearchParams(window.location.search);
            return params.get('channel') || 'chill';
        }
        // Extract current track index
        function getIdx() {
            const params = new URLSearchParams(window.location.search);
            return params.get('idx') || '0';
        }
        document.addEventListener('DOMContentLoaded', function () {
            const channel = getChannel();
            const idx = getIdx();
            const channelNames = {
                chill: 'Chill Vibes',
                focus: 'Focus Beats',
                nature: 'Nature Sounds',
            };
            document.getElementById('channel-title').textContent = channelNames[channel] || channel;
            const audio = document.getElementById('audio-player');
            audio.src = `/stream/${channel}?idx=${idx}`;
            // Auto play next track when current ends
            audio.addEventListener('ended', async function () {
                try {
                    const resp = await fetch(`/stream/${channel}?idx=${idx}`, { method: 'HEAD' });
                    const next = resp.headers.get('X-Next-Track');
                    if (next) {
                        const url = new URL(window.location.href);
                        url.searchParams.set('idx', (parseInt(idx, 10) + 1) % 99);
                        window.location.href = url.toString();
                    }
                } catch (e) {
                    // On failure, do nothing
                }
            });
        });
        // Dark mode helpers
        function setDarkMode(enabled) {
            if (enabled) {
                document.body.classList.add('dark');
            } else {
                document.body.classList.remove('dark');
            }
        }
        function getCookie(name) {
            const v = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
            return v ? v[2] : null;
        }
        function setCookie(name, value, days) {
            let expires = '';
            if (days) {
                const d = new Date();
                d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
                expires = '; expires=' + d.toUTCString();
            }
            document.cookie = name + '=' + value + expires + '; path=/';
        }
        function updateDarkModeBySystem() {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            setDarkMode(prefersDark);
        }
        function listenToSystemThemeChange(callback) {
            const mql = window.matchMedia('(prefers-color-scheme: dark)');
            if (mql.addEventListener) {
                mql.addEventListener('change', callback);
            } else if (mql.addListener) {
                mql.addListener(callback);
            }
        }
        document.addEventListener('DOMContentLoaded', function () {
            // 쿠키 우선, 없으면 시스템 테마
            const darkCookie = getCookie('darkmode');
            if (darkCookie === '1') setDarkMode(true);
            else if (darkCookie === '0') setDarkMode(false);
            else updateDarkModeBySystem();
            // 시스템 테마 변경 감지
            listenToSystemThemeChange(e => {
                setDarkMode(e.matches); // 시스템 테마로 즉시 변경
            });
            // 다크모드 토글 버튼
            document.getElementById('dark-toggle').addEventListener('click', function () {
                const isDark = document.body.classList.toggle('dark');
                setCookie('darkmode', isDark ? '1' : '0', 365);
            });
        });
    </script>
</head>

<body class="bg-gradient-to-br from-blue-200 to-purple-300 min-h-screen flex items-center justify-center">
    <button id="dark-toggle"
        class="absolute top-6 right-6 z-10 px-4 py-2 rounded-xl bg-white/40 hover:bg-white/60 shadow-md text-gray-700 font-semibold dark:text-gray-200 dark:bg-white/20">🌙/☀️</button>
    <div class="backdrop-blur-lg bg-white/30 rounded-3xl shadow-2xl p-10 w-full max-w-md flex flex-col items-center">
        <button onclick="window.history.back()"
            class="mb-6 px-4 py-2 rounded-xl bg-white/40 hover:bg-white/60 shadow-md text-gray-700 font-semibold">← Back
            to Channels</button>
        <h2 id="channel-title" class="text-2xl font-bold mb-8 text-gray-800">Channel Name</h2>
        <audio id="audio-player" controls autoplay class="w-full rounded-xl shadow-lg">
            <source src="" type="audio/mpeg">
            Your browser does not support the audio tag.
        </audio>
    </div>
</body>

</html>